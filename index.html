<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Porto Bello Hotel | Main Board</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- ‚úÖ Premium font for greeting -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&display=swap" rel="stylesheet">

<style>
:root{
  --row-gap:10px;
  --pad-x:18px;
  --pad-y:14px;

  /* ‚úÖ EN PRATƒ∞K √á√ñZ√úM: ticker i√ß bo≈üluk (sol/saƒü) */
  --ticker-pad: 28px;  /* 22-40 arasƒ± oyna: b√ºy√ºd√ºk√ße ikonlar daha g√∂r√ºn√ºr */

  /* ‚úÖ Greeting font */
  --greet-font: "Cormorant Garamond", serif;
}

html, body {
  margin: 0; width: 100%; height: 100%;
  background: #0b1320; color: #fff;
  font-family: Arial, Helvetica, sans-serif;
  overflow: hidden;
}

body {
  position: relative; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}

/* ===== Weather‚Äôa g√∂re arka plan (√ßok hafif) ===== */
body.mode-sunny{
  background:
    radial-gradient(900px 520px at 85% 15%, rgba(255,215,120,.10), transparent 55%),
    radial-gradient(900px 520px at 15% 85%, rgba(120,200,255,.06), transparent 60%),
    #0b1320;
}
body.mode-rain{
  background:
    radial-gradient(900px 520px at 70% 10%, rgba(120,200,255,.05), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.03), transparent 35%),
    #0b1320;
}
body.mode-snow{
  background:
    radial-gradient(900px 520px at 70% 10%, rgba(200,230,255,.07), transparent 60%),
    radial-gradient(900px 520px at 20% 90%, rgba(255,255,255,.04), transparent 60%),
    #0b1320;
}

/* ===== SUN LENS FLARE (premium, √ßok hafif) ===== */
#sunFlare{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:2;
  opacity:0;
  transition: opacity 700ms ease;
}
body.mode-sunny #sunFlare{ opacity: 1; }

.sunFlare__a{
  position:absolute;
  top:-18vh;
  right:-22vw;
  width: 80vw;
  height: 80vw;
  border-radius: 50%;
  background:
    radial-gradient(circle at 35% 35%,
      rgba(255,255,255,.20) 0%,
      rgba(255,230,160,.14) 12%,
      rgba(255,215,120,.10) 22%,
      rgba(255,215,120,.06) 34%,
      rgba(255,215,120,0) 60%);
  mix-blend-mode: screen;
}

.sunFlare__b{
  position:absolute;
  top: 8vh;
  right: 10vw;
  width: 26vw;
  height: 26vw;
  border-radius: 50%;
  background:
    radial-gradient(circle at 40% 40%,
      rgba(255,255,255,.10) 0%,
      rgba(255,230,160,.07) 22%,
      rgba(255,215,120,0) 58%);
  mix-blend-mode: screen;
  filter: blur(1px);
  opacity: .55;
}

.sunFlare__c{
  position:absolute;
  top: 26vh;
  right: 24vw;
  width: 10vw;
  height: 10vw;
  border-radius: 50%;
  background:
    radial-gradient(circle at 45% 45%,
      rgba(255,255,255,.08) 0%,
      rgba(255,215,120,.05) 18%,
      rgba(255,215,120,0) 62%);
  mix-blend-mode: screen;
  opacity: .45;
}

.sunFlare__ray{
  position:absolute;
  top:-6vh;
  right:-10vw;
  width: 120vw;
  height: 120vh;
  background: conic-gradient(
    from 210deg at 75% 15%,
    rgba(255,230,160,0) 0deg,
    rgba(255,230,160,.06) 8deg,
    rgba(255,230,160,0) 16deg,
    rgba(255,230,160,.04) 26deg,
    rgba(255,230,160,0) 36deg,
    rgba(255,230,160,.03) 48deg,
    rgba(255,230,160,0) 60deg,
    rgba(0,0,0,0) 360deg
  );
  mix-blend-mode: screen;
  filter: blur(1px);
  opacity: .55;
  transform-origin: 75% 15%;
  animation: flareDrift 10s ease-in-out infinite alternate;
}

@keyframes flareDrift{
  from { transform: rotate(-1.2deg) scale(1); }
  to   { transform: rotate(1.2deg) scale(1.02); }
}

/* LOGO */
.logo {
  position: absolute;
  top: 2px; left: 2px;
  width: 270px; opacity: .88;
  filter: drop-shadow(0 0 10px rgba(255,255,255,.08));
  user-select: none; pointer-events: none;
  z-index: 6;
}

/* WEATHER (TOP RIGHT) */
.weather {
  --w-scale: 1.5;
  position: absolute; top: 2px; right: 2px;
  padding: calc(10px * var(--w-scale)) calc(12px * var(--w-scale));
  background: rgba(0,0,0,.06);
  backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.04);
  border-radius: calc(10px * var(--w-scale));
  text-align: right;
  width: fit-content;
  max-width: min(560px, 46vw);
  box-sizing: border-box;
  z-index: 5;
  box-shadow:
    0 10px 30px rgba(0,0,0,.18),
    0 0 0 1px rgba(255,255,255,.02) inset;
}
.weather, .weather *{
  text-shadow:
    0 2px 10px rgba(0,0,0,.55),
    0 0 18px rgba(0,0,0,.35);
}
.weather .loc {
  font-size: calc(15px * var(--w-scale));
  opacity: .95;
  letter-spacing:.2px;
  white-space: nowrap;
}
.weather .topline{
  margin-top: calc(6px * var(--w-scale));
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: calc(10px * var(--w-scale));
  flex-wrap: nowrap;
}
.weather .icon{
  font-size: calc(26px * var(--w-scale));
  line-height: 1;
  filter:
    drop-shadow(0 2px 10px rgba(0,0,0,.55))
    drop-shadow(0 0 14px rgba(255,255,255,.08));
  flex: 0 0 auto;
}
.weather .cond{
  font-size: calc(14px * var(--w-scale));
  opacity: .92;
  letter-spacing: .2px;
  white-space: nowrap;
  flex: 0 1 auto;
}
.weather .main {
  margin-top: calc(4px * var(--w-scale));
  font-size: calc(22px * var(--w-scale));
  font-weight: 800;
  white-space: nowrap;
}
.weather .sub  {
  margin-top: calc(2px * var(--w-scale));
  font-size: calc(14px * var(--w-scale));
  opacity: .90;
  white-space: nowrap;
}
.weather .sub2 {
  margin-top: calc(2px * var(--w-scale));
  font-size: calc(14px * var(--w-scale));
  opacity: .90;
  white-space: nowrap;
}
/* ‚úÖ NEW: Sunrise/Sunset satƒ±rƒ± (etiketli) */
.weather .sub3{
  margin-top: calc(2px * var(--w-scale));
  font-size: calc(13px * var(--w-scale));
  opacity: .88;
  white-space: nowrap;
  letter-spacing: .15px;
}
@media (max-width: 600px){
  .weather{ --w-scale: 1.55; max-width: 92vw; right: 14px; top: 14px; }
}

/* ‚úÖ Center stack for greeting + clock + date */
.centerStack{
  position: relative;
  z-index: 4;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* ‚úÖ Premium Greeting */
#greeting{
  font-family: var(--greet-font);
  font-size: clamp(22px, 2.6vw, 42px);
  font-weight: 600;
  letter-spacing: 0.08em;
  opacity: .92;
  margin-bottom: 10px;
  text-align: center;
  text-shadow: 0 2px 14px rgba(0,0,0,.35), 0 0 22px rgba(0,0,0,.25);
  transform: translateY(0);
  transition: opacity 350ms ease, transform 350ms ease;
  user-select: none;
}

/* subtle divider line (premium touch) */
#greeting::after{
  content:"";
  display:block;
  width: clamp(160px, 18vw, 260px);
  height: 1px;
  margin: 12px auto 0;
  background: rgba(255,255,255,.85);
  opacity: .18;
}

/* fade swap */
#greeting.swap{
  opacity: 0;
  transform: translateY(-6px);
}

/* CLOCK + DATE */
#clock {
  font-size: clamp(72px, 9vw, 120px);
  font-weight: 750; letter-spacing: 4px;
  text-shadow: 0 0 12px rgba(255,255,255,.15), 0 0 24px rgba(255,255,255,.08);
}
#date {
  margin-top: 18px; font-size: clamp(24px, 3.2vw, 44px);
  opacity: .86; letter-spacing: 1px; font-weight: 300;
}

/* BOTTOM AREA (3 ROWS) */
.bottom {
  position: absolute; left: 0; right: 0; bottom: 0;
  padding: var(--pad-y) var(--pad-x) calc(var(--pad-y) + 4px);
  background: rgba(0,0,0,.18); backdrop-filter: blur(6px);
  border-top: 1px solid rgba(255,255,255,.08);
  display: flex; flex-direction: column; gap: var(--row-gap);
  z-index: 4;
}

.ticker {
  position: relative; width: 100%;
  line-height: 1.35; font-size: clamp(16px, 2.2vw, 28px);
  white-space: nowrap;
  overflow: hidden;

  /* ‚úÖ i√ßerik artƒ±k soldan/saƒüdan g√∂m√ºlmez */
  padding: 0 var(--ticker-pad);
  box-sizing: border-box;

  /* ‚úÖ fade/mask artƒ±k padding‚Äôe g√∂re √ßalƒ±≈üƒ±r */
  mask-image: linear-gradient(
    90deg,
    transparent 0,
    #000 var(--ticker-pad),
    #000 calc(100% - var(--ticker-pad)),
    transparent 100%
  );
  -webkit-mask-image: linear-gradient(
    90deg,
    transparent 0,
    #000 var(--ticker-pad),
    #000 calc(100% - var(--ticker-pad)),
    transparent 100%
  );
}

.belt {
  display: inline-flex; align-items: center; gap: 15px;
  will-change: transform;
}
.content { display: inline-flex; align-items: center; gap: 15px; }
.sep { opacity: .35; }

/* ‚úÖ‚úÖ EN PRATƒ∞K √á√ñZ√úM: Marquee YOKSA satƒ±rƒ± ortala */
.ticker:not(.marquee) .belt{
  display: flex;
  width: 100%;
  justify-content: center;
}

@keyframes pulse{ 0%{opacity:1} 50%{opacity:.45} 100%{opacity:1} }
.active{ animation: pulse 1.1s ease-in-out infinite; color:#ffd166; font-weight:700; text-shadow:0 0 14px rgba(255,209,102,.18); }
.activeGlow{ text-shadow:0 0 18px rgba(255,209,102,.20), 0 0 34px rgba(255,209,102,.10); }
.live{ animation: pulse 1s ease-in-out infinite; color:#8be9fd; font-weight:800; text-shadow:0 0 16px rgba(139,233,253,.18); }
.past{ opacity:.35; filter:saturate(.9); }

.badge{
  display:inline-block; margin-left:10px; padding:4px 10px; border-radius:999px;
  font-size:.65em; letter-spacing:.6px; font-weight:800; vertical-align:middle;
  background: rgba(255,209,102,.14); border:1px solid rgba(255,209,102,.22); text-transform:uppercase;
}
.badge-live{ background:rgba(139,233,253,.14); border:1px solid rgba(139,233,253,.25); }
.active .badge, .live .badge{ opacity:1!important; }

@keyframes marqueeShift{ from{ transform: translateX(0); } to{ transform: translateX(-50%); } }
.ticker.marquee .belt{ animation: marqueeShift var(--dur, 22s) linear infinite; }

/* ===== Weather FX Canvas (snow/rain) ===== */
#fxCanvas{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 3;
}
.fxGlow{
  filter: drop-shadow(0 0 6px rgba(255,255,255,.12));
}
</style>
</head>

<body>
<!-- SUN FLARE LAYER -->
<div id="sunFlare" aria-hidden="true">
  <div class="sunFlare__ray"></div>
  <div class="sunFlare__a"></div>
  <div class="sunFlare__b"></div>
  <div class="sunFlare__c"></div>
</div>

<!-- FX overlay -->
<canvas id="fxCanvas" class="fxGlow"></canvas>

<img src="logo.png" class="logo" alt="Porto Bello Hotel" />

<!-- Weather -->
<div class="weather" id="weatherBox">
  <div class="loc" id="wLoc">Antalya / Konyaaltƒ±</div>
  <div class="topline">
    <div class="icon" id="wIcon">üå°Ô∏è</div>
    <div class="cond" id="wCond">Loading‚Ä¶</div>
  </div>
  <div class="main" id="wMain">--¬∞C</div>
  <div class="sub"  id="wSub">Feels like --¬∞C ‚Ä¢ Humidity --%</div>
  <div class="sub2" id="wSub2">Wind -- km/h -- ‚Ä¢ Pressure ---- hPa</div>

  <!-- ‚úÖ NEW: sunrise / sunset -->
  <div class="sub3" id="wSun">üåÖ Sunrise --:-- ‚Ä¢ üåá Sunset --:--</div>
</div>

<!-- ‚úÖ Greeting + Clock + Date (Premium stack) -->
<div class="centerStack">
  <div id="greeting">Welcome</div>
  <div id="clock"></div>
  <div id="date"></div>
</div>

<div class="bottom">
  <div id="row1" class="ticker">
    <div class="belt">
      <div class="content" id="r1">
        <span id="breakfast">üç≥ Breakfast 07:00‚Äì10:30</span><span class="sep">|</span>
        <span id="lunch">üçΩÔ∏è Lunch 12:30‚Äì14:00</span><span class="sep">|</span>
        <span id="patisserie">üç∞ Patisserie 12:00‚Äì18:00</span>
      </div>
    </div>
  </div>

  <div id="row2" class="ticker">
    <div class="belt">
      <div class="content" id="r2">
        <span id="snack">üç™ Snack 14:30‚Äì15:30</span><span class="sep">|</span>
        <span id="dinner">üç∑ Dinner 18:30‚Äì21:00</span><span class="sep">|</span>
        <span id="sailorsBar">üç∫ Sailor's Pub 20:30‚Äì22:30</span>
      </div>
    </div>
  </div>

  <div id="row3" class="ticker">
    <div class="belt">
      <div class="content" id="r3">
        <span id="show">üéâ Animation 21:30</span><span class="sep">|</span>
        <span id="lateSnack">üåô Late Snack 23:00‚Äì06:00</span><span class="sep">|</span>
        <span id="lobbyBar">üç∏ Lobby Bar 08:30‚Äì00:00</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Time helpers ---------- */
const ids = ["breakfast","lunch","patisserie","snack","dinner","sailorsBar","show","lateSnack","lobbyBar"];
const toMin = (h,m)=>h*60+m;
const nowMin = d=>d.getHours()*60 + d.getMinutes();
const inRange = (n,s,e)=> s<e ? (n>=s && n<=e) : (s>e ? (n>=s || n<=e) : n===s);
const isPast  = (n,s,e)=> s<e ? (n>e) : ((n>e) && (n<s));

/* ---------- Schedule ---------- */
const schedule = {
  breakfast:{start:toMin(7,0),end:toMin(10,30),badge:"NOW OPEN",type:"food"},
  lunch:{start:toMin(12,30),end:toMin(14,0),badge:"NOW OPEN",type:"food"},
  patisserie:{start:toMin(12,0),end:toMin(18,0),badge:"NOW OPEN",type:"food"},
  snack:{start:toMin(14,30),end:toMin(15,30),badge:"NOW OPEN",type:"food"},
  dinner:{start:toMin(18,30),end:toMin(21,0),badge:"NOW OPEN",type:"food"},
  sailorsBar:{start:toMin(20,30),end:toMin(22,30),badge:"NOW OPEN",type:"food"},
  show:{start:toMin(21,30),end:toMin(22,30),badge:"LIVE NOW",type:"live"},
  lateSnack:{start:toMin(23,0),end:toMin(6,0),badge:"NOW OPEN",type:"food",noPast:true},
  lobbyBar:{start:toMin(8,30),end:1440,badge:"NOW OPEN",type:"food"}
};

function clearStates(){
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    el.classList.remove("active","activeGlow","live","past");
    const b=el.querySelector(".badge"); if(b) b.remove();
  });
}
function addBadge(el,text,isLive=false){
  const b=document.createElement("span");
  b.className="badge"+(isLive?" badge-live":"");
  b.textContent=text; el.appendChild(b);
}
function updateStates(d){
  const n=nowMin(d);
  clearStates();
  Object.entries(schedule).forEach(([key,rule])=>{
    const el=document.getElementById(key);
    if(!el) return;
    const active=inRange(n,rule.start,rule.end);
    const past=isPast(n,rule.start,rule.end);
    if(active){
      if(rule.type==="live"){ el.classList.add("live","activeGlow"); addBadge(el,rule.badge,true); }
      else { el.classList.add("active","activeGlow"); addBadge(el,rule.badge,false); }
    } else if (past && !rule.noPast){
      el.classList.add("past");
    }
  });
}

/* ---------- Premium Greeting (4 time ranges) ---------- */
let _lastGreeting = "";
function greetingForHour(h){
  // 05:00‚Äì11:59
  if (h >= 5 && h < 12) return "Good morning";
  // 12:00‚Äì17:59
  if (h >= 12 && h < 18) return "Good afternoon";
  // 18:00‚Äì22:59
  if (h >= 18 && h < 23) return "Good evening";
  // 23:00‚Äì04:59
  return "Good night";
}
function updateGreeting(d){
  const el = document.getElementById("greeting");
  if(!el) return;

  const next = greetingForHour(d.getHours());
  if (next === _lastGreeting) return;

  // premium soft transition
  el.classList.add("swap");
  setTimeout(()=>{
    el.textContent = next;
    el.classList.remove("swap");
  }, 220);

  _lastGreeting = next;
}

/* ---------- Clock & date ---------- */
function tick(){
  const d=new Date();

  document.getElementById("clock").textContent =
    d.toLocaleTimeString("en-GB",{hour12:false});

  document.getElementById("date").textContent  =
    d.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long",year:"numeric"});

  updateGreeting(d);
  updateStates(d);
}

/* ---------- Smart marquee ---------- */
function setupMarquee(rowId){
  const row = document.getElementById(rowId);
  if(!row) return;
  const belt = row.querySelector(".belt");
  const content = belt.querySelector(".content");
  if(!belt || !content) return;

  const needed = content.scrollWidth > row.clientWidth + 10;
  if(!needed){
    row.classList.remove("marquee");
    const clone=belt.querySelector(".content.clone");
    if(clone) clone.remove();
    return;
  }
  if(!belt.querySelector(".content.clone")){
    const clone = content.cloneNode(true);
    clone.classList.add("clone");
    belt.appendChild(clone);
  }
  const px = content.scrollWidth;
  const dur = Math.max(22, Math.min(70, px/35));
  row.style.setProperty('--dur', dur+'s');
  row.classList.add("marquee");
}
function setupAllMarquees(){ setupMarquee("row1"); setupMarquee("row2"); setupMarquee("row3"); }

/* ---------- Weather ---------- */
const WEATHER = { name:"Antalya / Konyaaltƒ±", lat:36.863965, lon:30.630398, tz:"Europe/Istanbul" };

function degToCardinal(deg){
  if (deg === null || deg === undefined || Number.isNaN(deg)) return "";
  const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  const idx = Math.round(((deg % 360) / 22.5)) % 16;
  return dirs[idx];
}
function wmoToIconAndText(code, isDay=true){
  const c = Number(code);
  if(Number.isNaN(c)) return { icon:"üå°Ô∏è", text:"Weather" };
  if (c === 95) return { icon:"‚õàÔ∏è", text:"Thunderstorm" };
  if (c === 96 || c === 99) return { icon:"‚õàÔ∏è", text:"Thunderstorm (hail)" };
  if (c === 71 || c === 73 || c === 75) return { icon:"‚ùÑÔ∏è", text:"Snow" };
  if (c === 77) return { icon:"üå®Ô∏è", text:"Snow grains" };
  if (c === 85 || c === 86) return { icon:"üå®Ô∏è", text:"Snow showers" };
  if (c === 66 || c === 67) return { icon:"üå®Ô∏è", text:"Freezing rain" };
  if (c === 51 || c === 53 || c === 55) return { icon:"üå¶Ô∏è", text:"Drizzle" };
  if (c === 56 || c === 57) return { icon:"üåßÔ∏è", text:"Freezing drizzle" };
  if (c === 61 || c === 63 || c === 65) return { icon:"üåßÔ∏è", text:"Rain" };
  if (c === 80 || c === 81 || c === 82) return { icon:"üåßÔ∏è", text:"Rain showers" };
  if (c === 45 || c === 48) return { icon:"üå´Ô∏è", text:"Fog" };
  if (c === 0) return { icon: isDay ? "‚òÄÔ∏è" : "üåô", text:"Clear sky" };
  if (c === 1) return { icon: isDay ? "üå§Ô∏è" : "üåô", text:"Mostly clear" };
  if (c === 2) return { icon:"‚õÖ", text:"Partly cloudy" };
  if (c === 3) return { icon:"‚òÅÔ∏è", text:"Overcast" };
  return { icon:"üå°Ô∏è", text:"Weather" };
}
function effectModeFromWMO(code, isDay){
  const c = Number(code);
  if(Number.isNaN(c)) return "none";
  const SNOW = new Set([71,73,75,77,85,86]);
  const RAIN = new Set([51,53,55,56,57,61,63,65,66,67,80,81,82,95,96,99]);
  const FOG  = new Set([45,48]);
  if (SNOW.has(c)) return "snow";
  if (RAIN.has(c)) return "rain";
  if (FOG.has(c))  return "none";
  if ((c === 0 || c === 1) && isDay) return "sun";
  return "none";
}

/* ---------- FX Engine ---------- */
const fx = {
  canvas:null, ctx:null, w:0, h:0, mode:"none", parts:[], raf:0,
  snowDensity:120, snowWind:0.25, snowSpeed:0.6, snowMaxR:3.2, snowMinR:0.8, snowDrift:0.6,
  rainDensity:180, rainSpeed:1.9, rainSlant:0.9
};
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function rnd(min,max){ return Math.random()*(max-min)+min; }

function resizeFX(){
  fx.w = window.innerWidth; fx.h = window.innerHeight;
  fx.canvas.width  = Math.floor(fx.w * devicePixelRatio);
  fx.canvas.height = Math.floor(fx.h * devicePixelRatio);
  fx.canvas.style.width = fx.w + "px";
  fx.canvas.style.height = fx.h + "px";
  fx.ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);

  const areaFactor = (fx.w * fx.h) / (1920*1080);
  if (fx.mode === "snow"){
    const target = clamp(Math.round(areaFactor * fx.snowDensity), 70, 240);
    fitParticles(target, () => newSnow(true));
  } else if (fx.mode === "rain"){
    const target = clamp(Math.round(areaFactor * fx.rainDensity), 90, 340);
    fitParticles(target, () => newRain(true));
  } else {
    fx.parts.length = 0;
    clearFX();
  }
}
function fitParticles(target, factory){
  if (fx.parts.length < target){ for(let i=fx.parts.length; i<target; i++) fx.parts.push(factory()); }
  else if (fx.parts.length > target){ fx.parts.length = target; }
}
function newSnow(randomY=false){
  const r = rnd(fx.snowMinR, fx.snowMaxR);
  return { t:"snow", x:rnd(0,fx.w), y:randomY?rnd(0,fx.h):rnd(-fx.h*0.2,0), r,
    vy:rnd(0.6,1.8)*(r/1.6)*fx.snowSpeed,
    vx:rnd(-0.35,0.35)+fx.snowWind,
    phase:rnd(0,Math.PI*2), omega:rnd(0.008,0.02), alpha:rnd(0.35,0.85)
  };
}
function newRain(randomY=false){
  const len = rnd(10,22);
  return { t:"rain", x:rnd(0,fx.w), y:randomY?rnd(0,fx.h):rnd(-fx.h*0.2,0),
    vy:rnd(6,12)*fx.rainSpeed,
    vx:rnd(2,5)*fx.rainSlant,
    len, alpha:rnd(0.18,0.38), w:rnd(1,1.6)
  };
}
function clearFX(){ fx.ctx.clearRect(0,0,fx.w,fx.h); }

function startFXLoop(){
  if (fx.raf) return;
  const loop = ()=>{ fx.raf = requestAnimationFrame(loop); drawFX(); };
  fx.raf = requestAnimationFrame(loop);
}
function stopFXLoop(){ if(!fx.raf) return; cancelAnimationFrame(fx.raf); fx.raf=0; }

function drawFX(){
  const ctx = fx.ctx;
  ctx.clearRect(0,0,fx.w,fx.h);

  if (fx.mode === "snow"){
    for(let i=0;i<fx.parts.length;i++){
      const f = fx.parts[i];
      f.phase += f.omega;
      const sway = Math.sin(f.phase) * fx.snowDrift;
      f.x += f.vx + sway*0.25; f.y += f.vy;
      if (f.y > fx.h + 10){ fx.parts[i] = newSnow(false); fx.parts[i].y = -10; continue; }
      if (f.x < -20) f.x = fx.w + 20;
      if (f.x > fx.w + 20) f.x = -20;
      ctx.beginPath();
      ctx.fillStyle = `rgba(255,255,255,${f.alpha})`;
      ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
      ctx.fill();
    }
    return;
  }

  if (fx.mode === "rain"){
    ctx.lineCap = "round";
    for(let i=0;i<fx.parts.length;i++){
      const d = fx.parts[i];
      d.x += d.vx; d.y += d.vy;
      if (d.y > fx.h + 30 || d.x > fx.w + 30){
        fx.parts[i] = newRain(false);
        fx.parts[i].y = -20;
        fx.parts[i].x = rnd(-50, fx.w);
        continue;
      }
      ctx.beginPath();
      ctx.strokeStyle = `rgba(180,220,255,${d.alpha})`;
      ctx.lineWidth = d.w;
      ctx.moveTo(d.x, d.y);
      ctx.lineTo(d.x - d.vx*0.6, d.y - d.len);
      ctx.stroke();
    }
    return;
  }
}
function setMode(mode){
  if (!mode) mode = "none";
  if (fx.mode === mode) return;
  fx.mode = mode;

  document.body.classList.remove("mode-snow","mode-rain","mode-sunny");
  if (mode === "snow") document.body.classList.add("mode-snow");
  if (mode === "rain") document.body.classList.add("mode-rain");
  if (mode === "sun")  document.body.classList.add("mode-sunny");

  fx.parts.length = 0;
  resizeFX();

  if (mode === "none" || mode === "sun"){
    stopFXLoop();
    clearFX();
    return;
  }
  startFXLoop();
}
function initFX(){
  fx.canvas = document.getElementById("fxCanvas");
  fx.ctx = fx.canvas.getContext("2d", { alpha: true });
  resizeFX();
  setMode("none");
}

/* ---------- Helpers: Sunrise/Sunset formatting ---------- */
function fmtTimeFromISO(iso){
  if(!iso) return "--:--";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "--:--";
  return d.toLocaleTimeString("tr-TR", { hour: "2-digit", minute: "2-digit", hour12:false });
}

/* ---------- Weather fetch ---------- */
async function fetchWeather(){
  const url =
    "https://api.open-meteo.com/v1/forecast"
    + "?latitude=" + encodeURIComponent(WEATHER.lat)
    + "&longitude=" + encodeURIComponent(WEATHER.lon)
    + "&current=" + encodeURIComponent("temperature_2m,apparent_temperature,relative_humidity_2m,wind_speed_10m,wind_direction_10m,surface_pressure,weather_code,is_day")
    + "&daily=" + encodeURIComponent("sunrise,sunset")
    + "&forecast_days=1"
    + "&timezone=" + encodeURIComponent(WEATHER.tz);

  try{
    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok) throw new Error("HTTP " + r.status);
    const j = await r.json();
    const c = j.current || {};

    const t = Math.round(c.temperature_2m);
    const feels = Math.round(c.apparent_temperature);
    const hum = Math.round(c.relative_humidity_2m);
    const wind = Math.round(c.wind_speed_10m);
    const wdir = degToCardinal(Number(c.wind_direction_10m));
    const pres = Math.round(c.surface_pressure);

    const isDay = Number(c.is_day) === 1;
    const wx = wmoToIconAndText(c.weather_code, isDay);

    document.getElementById("wLoc").textContent = WEATHER.name;
    document.getElementById("wIcon").textContent = wx.icon;
    document.getElementById("wCond").textContent = wx.text;

    document.getElementById("wMain").textContent = `${t}¬∞C`;
    document.getElementById("wSub").textContent  = `Feels like ${feels}¬∞C ‚Ä¢ Wind ${wind} km/h ${wdir}`;
    document.getElementById("wSub2").textContent = `Humidity ${hum}% ‚Ä¢ Pressure ${pres} hPa`;

    // ‚úÖ Sunrise / Sunset (etiketli)
    const sunriseISO = j?.daily?.sunrise?.[0];
    const sunsetISO  = j?.daily?.sunset?.[0];
    const sunrise = fmtTimeFromISO(sunriseISO);
    const sunset  = fmtTimeFromISO(sunsetISO);
    const sunEl = document.getElementById("wSun");
    if(sunEl){
      sunEl.textContent = `üåÖ Sunrise ${sunrise} ~ üåá Sunset ${sunset}`;
    }

    setMode(effectModeFromWMO(c.weather_code, isDay));
  }catch(e){
    document.getElementById("wCond").textContent = "Weather unavailable";
    const sunEl = document.getElementById("wSun");
    if(sunEl) sunEl.textContent = "üåÖ Sunrise --:-- ‚Ä¢ üåá Sunset --:--";
    setMode("none");
  }
}

/* ---------- Init ---------- */
tick(); setupAllMarquees(); initFX(); fetchWeather();
setInterval(tick, 1000);
setInterval(setupAllMarquees, 4000);
setInterval(fetchWeather, 10 * 60 * 1000);
window.addEventListener('resize', ()=>{ setupAllMarquees(); resizeFX(); });
</script>
</body>
</html>
